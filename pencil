#!/usr/bin/env python3
import curses, sys, os

filename = sys.argv[1] if len(sys.argv) > 1 else input('filename? ')
os.system(f"touch '{filename}'")

try: lines = open(filename).read().splitlines()
except FileNotFoundError: lines = [""]

def main(stdscr):
    curses.curs_set(1)
    stdscr.keypad(True)
    y, x = 0, 0
    while True:
        stdscr.clear()
        for i, line in enumerate(lines[:curses.LINES]):
            stdscr.addstr(i, 0, line[:curses.COLS - 1])
        x = min(x, len(lines[y]))
        stdscr.move(y, x)
        stdscr.refresh()
        try: c = stdscr.get_wch()
        except curses.error: continue
        if c == '\x1b': break
        elif c == curses.KEY_UP: y = max(0, y-1)
        elif c == curses.KEY_DOWN: y = min(len(lines)-1, y+1)
        elif c == curses.KEY_LEFT: x = max(0, x-1)
        elif c == curses.KEY_RIGHT: x = min(len(lines[y]), x+1)
        elif c in ('\b', '\x7f', curses.KEY_BACKSPACE):
            if x > 0: lines[y] = lines[y][:x-1] + lines[y][x:]; x -= 1
            elif y > 0: x = len(lines[y-1]); lines[y-1] += lines[y]; lines.pop(y); y -= 1
        elif c == '\n':
            lines.insert(y+1, lines[y][x:])
            lines[y] = lines[y][:x]
            y += 1; x = 0
        elif isinstance(c, str):
            while y >= len(lines): lines.append("")
            lines[y] = lines[y][:x] + c + lines[y][x:]
            x += 1

    open(filename, "w").write("\n".join(lines))

curses.wrapper(main)
